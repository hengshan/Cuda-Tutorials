# ç¬¬5è¯¾è®²ä¹‰ï¼šWarpçº§åˆ«ä¼˜åŒ– - ShuffleæŒ‡ä»¤

## è¯¾å‰å›é¡¾ (1åˆ†é’Ÿ)

å‰ä¸¤èŠ‚è¯¾æˆ‘ä»¬å­¦äº†ï¼š
- ç¬¬3è¯¾ï¼šç»Ÿä¸€å†…å­˜ + åŸå­æ“ä½œï¼ˆç®€å•ä½†æ…¢ï¼‰
- ç¬¬4è¯¾ï¼šå…±äº«å†…å­˜ + å½’çº¦æ ‘ï¼ˆæå‡3-5å€ï¼‰

**ä»Šå¤©ç›®æ ‡**ï¼šå†æå‡1.5-2å€ï¼Œè¾¾åˆ°30-50å€æ€»åŠ é€Ÿï¼

---

## ä»Šå¤©è¦è§£å†³çš„é—®é¢˜ (1åˆ†é’Ÿ)

**é—®é¢˜**ï¼šç¬¬4è¯¾è¿˜æœ‰ä¼˜åŒ–ç©ºé—´å—ï¼Ÿ
- å…±äº«å†…å­˜è¿˜æ˜¯æœ‰å»¶è¿Ÿï¼ˆ20-30ä¸ªæ—¶é’Ÿå‘¨æœŸï¼‰
- `__syncthreads()`æœ‰å¼€é”€
- èƒ½å¦æ›´å¿«ï¼Ÿ

**ç­”æ¡ˆ**ï¼šWarpçº§ç¼–ç¨‹ï¼ç›´æ¥åœ¨å¯„å­˜å™¨é—´é€šä¿¡ã€‚

---

## æ ¸å¿ƒæ¦‚å¿µé€Ÿè®² (3åˆ†é’Ÿ)

### 1. ä»€ä¹ˆæ˜¯Warpï¼Ÿ

**å®šä¹‰**ï¼š
- 32ä¸ªçº¿ç¨‹çš„æ‰§è¡Œå•å…ƒ
- GPUç¡¬ä»¶è°ƒåº¦çš„æœ€å°å•ä½
- SIMT (Single Instruction Multiple Threads)

**ç‰¹ç‚¹**ï¼š
```
ä¸€ä¸ªBlock (256çº¿ç¨‹) = 8ä¸ªWarps (æ¯ä¸ª32çº¿ç¨‹)
çº¿ç¨‹0-31:   Warp 0
çº¿ç¨‹32-63:  Warp 1
...
çº¿ç¨‹224-255: Warp 7
```

**å…³é”®**ï¼šWarpå†…çš„32ä¸ªçº¿ç¨‹è‡ªåŠ¨åŒæ­¥æ‰§è¡Œï¼

---

### 2. ShuffleæŒ‡ä»¤

**ä¼ ç»Ÿé€šä¿¡**ï¼ˆç¬¬4è¯¾ï¼‰ï¼š
```cuda
__shared__ int data[256];
data[tid] = value;        // å†™å…±äº«å†…å­˜
__syncthreads();          // åŒæ­¥
int neighbor = data[tid+1];  // è¯»å…±äº«å†…å­˜
```

**Shuffleé€šä¿¡**ï¼ˆä»Šå¤©ï¼‰ï¼š
```cuda
int value = ...;
int neighbor = __shfl_down_sync(0xffffffff, value, 1);
// ç›´æ¥ä»å³è¾¹çº¿ç¨‹çš„å¯„å­˜å™¨è¯»å–ï¼Œæ— éœ€å†…å­˜ï¼
```

**ä¼˜åŠ¿**ï¼š
- é€Ÿåº¦ï¼š1ä¸ªæ—¶é’Ÿå‘¨æœŸ vs 20+æ—¶é’Ÿå‘¨æœŸ
- æ— éœ€å…±äº«å†…å­˜
- æ— éœ€`__syncthreads()`

---

### 3. Shuffleå½’çº¦ç¤ºä¾‹

**Warpå†…8ä¸ªçº¿ç¨‹æ±‚æœ€å¤§å€¼**ï¼ˆç®€åŒ–è¯´æ˜ï¼‰ï¼š
```
åˆå§‹å€¼: [3, 7, 2, 9, 1, 5, 4, 8]
Lane:     0  1  2  3  4  5  6  7

offset=4:
  Lane0: val=3, ä»Lane4è¯»åˆ°1, max(3,1)=3
  Lane1: val=7, ä»Lane5è¯»åˆ°5, max(7,5)=7
  Lane2: val=2, ä»Lane6è¯»åˆ°4, max(2,4)=4
  Lane3: val=9, ä»Lane7è¯»åˆ°8, max(9,8)=9
  ç»“æœ: [3, 7, 4, 9, -, -, -, -]

offset=2:
  Lane0: val=3, ä»Lane2è¯»åˆ°4, max(3,4)=4
  Lane1: val=7, ä»Lane3è¯»åˆ°9, max(7,9)=9
  ç»“æœ: [4, 9, -, -, -, -, -, -]

offset=1:
  Lane0: val=4, ä»Lane1è¯»åˆ°9, max(4,9)=9
  ç»“æœ: [9, -, -, -, -, -, -, -]

æœ€ç»ˆï¼šLane 0 = 9 (æ•´ä¸ªWarpçš„æœ€å¤§å€¼)
```

---

### 4. Warp Shuffleå‡½æ•°æ—

| å‡½æ•° | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `__shfl_sync(mask, var, srcLane)` | ä»æŒ‡å®šlaneè¯»å– | æ‰€æœ‰çº¿ç¨‹ä»lane 0è¯» |
| `__shfl_down_sync(mask, var, delta)` | ä»å³è¾¹deltaä¸ªçº¿ç¨‹è¯» | å½’çº¦å¸¸ç”¨ |
| `__shfl_up_sync(mask, var, delta)` | ä»å·¦è¾¹deltaä¸ªçº¿ç¨‹è¯» | å‰ç¼€å’Œ |
| `__shfl_xor_sync(mask, var, laneMask)` | æŒ‰ä½å¼‚æˆ–äº¤æ¢ | è¶å¼å½’çº¦ |

**maskå‚æ•°**ï¼š`0xffffffff` è¡¨ç¤ºå…¨éƒ¨32ä¸ªçº¿ç¨‹éƒ½å‚ä¸

---

## ä»Šå¤©çš„ä»£ç ç»“æ„

```cuda
// Warpå†…å½’çº¦å‡½æ•°
__device__ int warpReduceMax(int val) {
    for (int offset = 16; offset > 0; offset >>= 1) {
        int neighbor = __shfl_down_sync(0xffffffff, val, offset);
        val = max(val, neighbor);
    }
    return val;  // Lane 0æŒæœ‰warpæœ€å¤§å€¼
}

__global__ void findMaxGPU_warp(int *data, int n, int *result) {
    // 1. æ¯ä¸ªçº¿ç¨‹æ‰¾å±€éƒ¨æœ€å¤§å€¼
    int local_max = ...;

    // 2. Warpå†…å½’çº¦ï¼ˆç”¨shuffleï¼‰
    local_max = warpReduceMax(local_max);

    // 3. æ¯ä¸ªwarpçš„lane 0å†™å…¥å…±äº«å†…å­˜
    __shared__ int warp_maxes[8];  // å‡è®¾8ä¸ªwarps
    if (lane == 0) warp_maxes[warpId] = local_max;
    __syncthreads();

    // 4. ç¬¬ä¸€ä¸ªwarpå¯¹æ‰€æœ‰warpç»“æœå½’çº¦
    if (warpId == 0) {
        int val = warp_maxes[lane];
        val = warpReduceMax(val);
        if (lane == 0) atomicMax(result, val);
    }
}
```

---

## æ€§èƒ½å¯¹æ¯”é¢„æœŸ

| å®ç° | è€—æ—¶ | åŠ é€Ÿæ¯”(vs CPU) | ç´¯è®¡ä¼˜åŒ– |
|------|------|---------------|---------|
| ç¬¬3è¯¾æœ´ç´ ç‰ˆ | ~5ms | 10x | - |
| ç¬¬4è¯¾å…±äº«å†…å­˜ | ~1.5ms | 33x | 3.3x |
| ç¬¬5è¯¾Warp Shuffle | ~0.8ms | 60x | 2x |

---

## æœ¬èŠ‚è¯¾ç›®æ ‡

å­¦å®Œåä½ åº”è¯¥èƒ½ï¼š
- âœ… ç†è§£Warpçš„æ¦‚å¿µå’Œæ‰§è¡Œæ¨¡å‹
- âœ… ä¼šä½¿ç”¨`__shfl_down_sync()`
- âœ… å®ç°warpçº§å½’çº¦å‡½æ•°
- âœ… çŸ¥é“ä½•æ—¶ç”¨Shuffle vs å…±äº«å†…å­˜

---

## æ¥ä¸‹æ¥ï¼š20åˆ†é’Ÿ Live Coding

é‡ç‚¹è®²è§£ï¼š
1. `warpReduceMax()`å‡½æ•°å®ç°
2. Laneå’ŒWarpIdè®¡ç®—
3. ä¸¤çº§å½’çº¦ï¼šWarpå†… + Warpé—´
4. æ€§èƒ½å¯¹æ¯”å®éªŒ

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å†™å‡ºæœ€å¿«çš„å½’çº¦ä»£ç ï¼ğŸš€
